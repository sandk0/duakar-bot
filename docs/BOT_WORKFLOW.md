# –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã Telegram VPN –±–æ—Ç–∞

## –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram      ‚îÇ    ‚îÇ   VPN Bot       ‚îÇ    ‚îÇ   Marzban       ‚îÇ
‚îÇ   User          ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   System        ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   VPN Server    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ   PostgreSQL    ‚îÇ
                       ‚îÇ   Database      ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Telegram Bot (aiogram 3.x)
- **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `bot/main.py`
- **–§—É–Ω–∫—Ü–∏–∏**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- **Handlers**: –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- **–ú–æ–¥–µ–ª–∏**: SQLAlchemy ORM –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- **–°–µ—Å—Å–∏–∏**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ handler'–∞
- **–ú–∏–≥—Ä–∞—Ü–∏–∏**: Alembic –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–æ–π –ë–î

### 3. Marzban VPN Server
- **API –∫–ª–∏–µ–Ω—Ç**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**: –°–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ VPN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- **–ü—Ä–æ—Ç–æ–∫–æ–ª—ã**: VLESS TCP REALITY

## –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```mermaid
sequenceDiagram
    participant U as User
    participant B as Bot
    participant DB as Database
    participant M as Marzban

    U->>B: /start
    B->>DB: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    alt –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        B->>DB: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        Note over DB: –¢–∞–±–ª–∏—Ü–∞ users
    end
    B->>U: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –º–µ–Ω—é
```

**–§–∞–π–ª—ã**: `bot/handlers/start_handler.py`
**–¢–∞–±–ª–∏—Ü—ã –ë–î**: `users`

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞

```mermaid
sequenceDiagram
    participant U as User
    participant B as Bot
    participant DB as Database
    participant M as Marzban

    U->>B: –ù–∞–∂–∞—Ç—å "–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥"
    B->>DB: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å trial_used = false
    alt –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω
        B->>DB: –°–æ–∑–¥–∞—Ç—å subscription (TRIAL, 3 –¥–Ω—è)
        B->>M: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VPN
        M-->>B: –í–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥ VLESS
        B->>DB: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å VPN config
        B->>DB: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å trial_used = true
        B->>U: "–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
    else –£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
        B->>U: "–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω"
    end
```

**–§–∞–π–ª—ã**: `bot/handlers/subscription_handler.py`, `services/marzban/client.py`
**–¢–∞–±–ª–∏—Ü—ã –ë–î**: `users`, `subscriptions`, `vpn_configs`

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—É—á–µ–Ω–∏–µ VPN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```mermaid
sequenceDiagram
    participant U as User
    participant B as Bot
    participant DB as Database

    U->>B: /config –∏–ª–∏ "–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥"
    B->>DB: –ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
    B->>DB: –ù–∞–π—Ç–∏ VPN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    alt –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞
        B->>U: –ú–µ–Ω—é: QR-–∫–æ–¥ | –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        alt QR-–∫–æ–¥
            B->>U: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å QR-–∫–æ–¥
        else –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
            B->>U: –¢–µ–∫—Å—Ç —Å VLESS URL
        end
    else –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
        B->>U: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏"
    end
```

**–§–∞–π–ª—ã**: `bot/handlers/config_handler.py`, `services/marzban/utils.py`
**–¢–∞–±–ª–∏—Ü—ã –ë–î**: `subscriptions`, `vpn_configs`

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏

```mermaid
sequenceDiagram
    participant U as User
    participant B as Bot
    participant DB as Database
    participant P as Payment System
    participant M as Marzban

    U->>B: "–û–ø–ª–∞—Ç–∏—Ç—å/–ü—Ä–æ–¥–ª–∏—Ç—å"
    B->>U: –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
    U->>B: –í—ã–±—Ä–∞—Ç—å –ø–ª–∞–Ω (–º–µ—Å—è—Ü/–∫–≤–∞—Ä—Ç–∞–ª/–≥–æ–¥)
    B->>DB: –°–æ–∑–¥–∞—Ç—å Payment (PENDING)
    B->>P: –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ (Wata/YooKassa)
    P-->>B: –í–µ—Ä–Ω—É—Ç—å payment URL
    B->>U: –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
    
    Note over P: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
    
    P->>B: Webhook –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
    B->>DB: –û–±–Ω–æ–≤–∏—Ç—å Payment (SUCCESS)
    B->>DB: –°–æ–∑–¥–∞—Ç—å/–ø—Ä–æ–¥–ª–∏—Ç—å Subscription
    B->>M: –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å VPN –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    B->>DB: –û–±–Ω–æ–≤–∏—Ç—å VPN config
    B->>U: "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"
```

**–§–∞–π–ª—ã**: `bot/handlers/payment_handler.py`, `services/payment/`
**–¢–∞–±–ª–∏—Ü—ã –ë–î**: `payments`, `subscriptions`, `vpn_configs`, `pricing_plans`

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

```mermaid
sequenceDiagram
    participant R as Referrer
    participant N as New User
    participant B as Bot
    participant DB as Database

    R->>B: /referral
    B->>DB: –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    B->>R: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    
    R->>N: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π
    N->>B: /start?ref=REFERRER_ID
    B->>DB: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å referred_by
    
    Note over N: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
    
    B->>DB: –û–±–Ω–æ–≤–∏—Ç—å referral_stats (bonus_days_earned += 7)
    B->>R: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –¥–Ω—è—Ö
```

**–§–∞–π–ª—ã**: `bot/handlers/referral_handler.py`
**–¢–∞–±–ª–∏—Ü—ã –ë–î**: `users`, `referral_stats`

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### –°—Ö–µ–º–∞ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥

```mermaid
graph TD
    A[/admin] --> B[–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å]
    B --> C[üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]
    B --> D[üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏]
    B --> E[üí∞ –ü–ª–∞—Ç–µ–∂–∏]
    B --> F[üì¢ –†–∞—Å—Å—ã–ª–∫–∞]
    B --> G[‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏]
    
    C --> C1[–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã]
    D --> D1[–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π]
    D --> D2[–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞]
    E --> E1[–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏]
    F --> F1[–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞]
    G --> G1[–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏]
    
    RESET[/reset_trial] --> RESET1[–°–±—Ä–æ—Å –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞]
```

**–§–∞–π–ª—ã**: `bot/handlers/admin_handler.py`
**–î–æ—Å—Ç—É–ø**: –ü–æ Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (17499218)

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### users
```sql
- id (PK)
- telegram_id (UNIQUE)
- username, first_name, last_name
- trial_used (boolean)
- referred_by (FK -> users.id)
- created_at, updated_at
```

#### subscriptions
```sql
- id (PK)
- user_id (FK -> users.id)
- plan_id (FK -> pricing_plans.id)
- status (active, expired, trial, cancelled)
- start_date, end_date
- is_trial (boolean)
- created_at, updated_at
```

#### vpn_configs
```sql
- id (PK)
- user_id (FK -> users.id)
- marzban_user_id (UNIQUE)
- config_data (VLESS URL)
- is_active (boolean)
- created_at, updated_at
```

#### payments
```sql
- id (PK)
- user_id (FK -> users.id)
- plan_id (FK -> pricing_plans.id)
- amount, currency
- status (pending, success, failed)
- system (wata, yookassa)
- external_id, payment_url
- created_at, updated_at, completed_at
```

#### pricing_plans
```sql
- id (PK)
- name, description
- price, currency
- duration_days
- is_active (boolean)
- created_at
```

## –°–µ—Ä–≤–∏—Å—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. Marzban API Client (`services/marzban/`)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã**:
- `create_user()` - –°–æ–∑–¥–∞–Ω–∏–µ VPN –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `get_user()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `delete_user()` - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `get_user_config()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `update_user()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**:
```python
CreateUserRequest(
    username=unique_username,
    expire=expire_timestamp,
    data_limit=data_limit_bytes,
    inbounds={"vless": ["VLESS TCP REALITY"]},
    excluded_inbounds={"vless": []}
)
```

### 2. Payment Services (`services/payment/`)

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–∏—Å—Ç–µ–º—ã**:
- **Wata**: –†–æ—Å—Å–∏–π—Å–∫–∞—è –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
- **YooKassa**: –ÆKassa (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Å—Å–∞)

**–ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã**:
1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –ë–î (status=PENDING)
2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–µ
3. –ü–æ–ª—É—á–µ–Ω–∏–µ payment_url –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–∞
5. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ

### 3. Background Tasks (`tasks/`)

**Celery Worker** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- Backup –¥–∞–Ω–Ω—ã—Ö

## Middleware –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Middleware –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **AuthMiddleware**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–æ—Ç–∫–ª—é—á–µ–Ω –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç)
- **ThrottlingMiddleware**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ—Ç–∫–ª—é—á–µ–Ω)
- **LoggingMiddleware**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π (–æ—Ç–∫–ª—é—á–µ–Ω)

### Session Management
–ö–∞–∂–¥—ã–π handler —Å–æ–∑–¥–∞–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

```python
session = async_session_maker()
try:
    # –†–∞–±–æ—Ç–∞ —Å –ë–î
    pass
finally:
    await session.close()
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### Prometheus + Grafana
- **Prometheus**: –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —Å–∏—Å—Ç–µ–º—ã
- **Grafana**: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- **Alerts**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–£—Ä–æ–≤–Ω–∏**: INFO, WARNING, ERROR
- **–†–æ—Ç–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
- **–§–æ—Ä–º–∞—Ç—ã**: JSON –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker Compose –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```yaml
services:
  - postgres (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
  - redis (–ö–µ—à –∏ –æ—á–µ—Ä–µ–¥–∏)
  - bot (Telegram –±–æ—Ç)
  - api (REST API)
  - worker (Celery –∑–∞–¥–∞—á–∏)
  - beat (–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á)
  - flower (Monitoring Celery)
  - prometheus (–ú–µ—Ç—Ä–∏–∫–∏)
  - grafana (–î–∞—à–±–æ—Ä–¥—ã)
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `BOT_TOKEN`: –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `DATABASE_URL`: URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
- `REDIS_URL`: URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis
- `MARZBAN_*`: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Marzban
- `PAYMENT_*`: –ö–ª—é—á–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
1. **Database errors**: –û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **Marzban API errors**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏, —Ñ–æ–ª–ª–±–µ–∫
3. **Payment errors**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
4. **User input errors**: –í–∞–ª–∏–¥–∞—Ü–∏—è, –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **Backup**: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **Health checks**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
- **Restart policies**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —É–ø–∞–≤—à–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Bot instances**: –ù–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞
- **Worker nodes**: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Celery –≤–æ—Ä–∫–µ—Ä–æ–≤
- **Database**: Read replicas –¥–ª—è —á—Ç–µ–Ω–∏—è

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **Connection pooling**: –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î
- **Caching**: Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **Async operations**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

---

**–°–æ–∑–¥–∞–Ω–æ**: $(date)
**–í–µ—Ä—Å–∏—è**: v1.0
**–°—Ç–∞—Ç—É—Å**: –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞